<%
  hash = {
    title: "#{@episode.title} — #{@channel.title}",
    og: {
      title: @episode.title,
      type: 'website',
      image: Imgix.client.path(@episode.image.s3_path).w(1200).h(1200).fit('crop').q(50).fm('pjpg').to_url,
      url: slugged_channel_episode_url(@channel.slug, @episode.slug),
      audio: {
        url: @episode.audio_url,
        secure_url: @episode.audio_url,
        type: "audio/mpeg"
      },
      site_name: "Ruby.fm"
    },
    twitter: {
    }
  }

  if @episode.notes.present?
    stripped = strip_tags(markdown(@episode.notes).squish)
    hash[:description] = truncate(stripped, length: 160)
    hash[:og][:description] = truncate(stripped, length: 300)
  else
    hash[:description] = ""
  end

  meta(hash)
%>

<% content_for :favicon do %>
  <%= Imgix.client.path(@episode.image.s3_path).w(32).h(32).fit('crop').fm('png32').to_url %>
<% end %>

<div class="container">
  <div class="sm-col-12 md-col-6 mx-auto">
  <header class="clearfix">
    <div class="flex flex-center p2">
      <div class="flex-none">
        <%= link_to slugged_channel_path(@channel) do %>
          <%= image_tag(Imgix.client.path(@channel.image.s3_path).h(48).w(48).dpr(2).fit('crop').mask('ellipse').fm('png').to_url, width: 48, height: 48, class: 'mb0 mr2') %>
        <% end %>
      </div>
      <div class="flex-auto sm-col col-9">
        <h2 class="black block h4 m0 truncate"><%= link_to @channel.title, slugged_channel_path(@channel), class: 'black' %></h2>
        <h3 class="h5 m0 gray truncate">
          <%= @episode.created_at.strftime("%b %e") %>
          ∙
          <%= "#{distance_of_time_in_words(@episode.length)} long" %>
        </h3>
      </div>
      <div class="flex-none md-show">
        <% if policy(@channel).update? %>
          <%= link_to 'Edit', edit_episode_path(@episode.id), class: 'gray h5 btn btn-outline'  %>
        <% end %>
        <%= link_to('Download', @episode.audio_url, class: 'gray h5 btn btn-outline') %>
      </div>
    </div>
  </header>
  <div class="square bg-black">
    <div class="absolute">
      <%= image_tag(Imgix.client.path(@episode.image.s3_path).h(512).w(512).dpr(2).fit('crop').fm('pjpg').to_url, class: 'pointer block js-art col-12') %>
      <%= image_tag('play.svg', class: 'js-art js-hide-show episode-play') %>
      <div class="player">
        <audio controls preload="auto">
          <source src="<%= @episode.audio %>" type="audio/mp3">
        </audio>
        <input id='seek{id}' class='player-progress-seek' type='range' min='0' max='100' step='0.5' value='0' data-player='seek'>
        <progress class='player-progress-played' max='100' value='0'>
        </progress>
        <progress class='player-progress-buffer' max='100' value='0'>
        </progress>
      </div>
    </div>
  </div>

  <h1 class="black block h2 mb0 mt2 px2"><%= @episode.title %></h1>
  <% if @episode.notes.present? %>
    <div class="p2">
      <%= markdown(@episode.notes) %>
    </div>
  <% end %>

  <% if @channel.episodes.count > 1 %>
    <h4 class="caps gray h6 p2">More from <%= @channel.title %></h4>
    <section class="flex flex-wrap mb2">
      <% @channel.episodes.where.not(id: @episode.id).order(created_at: :desc).first(3).each do |t| %>
        <div class="flex col-4 md-col-4 lg-col-4 border-box">
          <div class="">
            <%= link_to(slugged_channel_episode_path(@channel.slug, t.slug)) do %>
              <%= image_tag(Imgix.client.path(t.image.s3_path).fit('crop').width(400).height(400).to_url, class: 'col-12') %>
            <% end %>
            <div class="p1">
              <h2 class="h5 m0 black">
                <%= link_to( t.title, slugged_channel_episode_path(@channel.slug, t.slug), class: 'black') %>
              </h2>
            </div>
          </div>
        </div>
      <% end %>
    </section>
  <% end %>
</div>


<script data-turbolinks-eval=always>
  plyr.setup(
    {
      html: ["<div class='player-controls'>", "</div>"].join("\n")
    }
  );
</script>
<script data-turbolinks-eval=always>
  // Album art on-click plays or pauses
  $(".js-art").click(function() {
    document.querySelectorAll(".player")[0].plyr.togglePlay();
    $(".js-hide-show").toggle();
  });
</script>
